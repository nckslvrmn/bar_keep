<div class="container-fluid px-3" data-controller="item-filter offline">
  <!-- Offline Banner -->
  <div class="alert alert-warning d-none mb-3" data-offline-target="banner" role="alert">
    <strong>ðŸ“µ Offline Mode</strong> - You're viewing cached inventory. Editing is disabled until you're back online.
  </div>

  <div class="row">
    <div class="col-md-3 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Filters</h5>

          <% if params[:category_ids].present? %>
            <div class="alert alert-info mb-3">
              <strong>Filtering by categories (<%= params[:category_match] == "all" ? "ALL" : "ANY" %>):</strong><br>
              <% selected_categories = Category.where(id: params[:category_ids]) %>
              <% selected_categories.each do |cat| %>
                <span class="badge bg-primary"><%= cat.name %></span>
              <% end %>
            </div>
          <% end %>

          <div class="mb-3">
            <%= text_field_tag :search, params[:search],
                class: "form-control",
                placeholder: "Search items...",
                data: {
                  "item-filter-target": "searchInput",
                  action: "input->item-filter#onSearchInput"
                } %>
          </div>

          <div class="mb-3">
            <button class="btn btn-link p-0 text-decoration-none text-start w-100 d-flex justify-content-between align-items-center"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#categoriesCollapse"
                    aria-expanded="false"
                    aria-controls="categoriesCollapse">
              <span class="form-label mb-0">Categories</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
              </svg>
            </button>
            <div class="collapse" id="categoriesCollapse">
              <div class="category-filters mt-2" style="max-height: 200px; overflow-y: auto;">
                <% @categories.each do |category| %>
                  <div class="form-check">
                    <%= check_box_tag "category_ids[]", category.id,
                        params[:category_ids]&.include?(category.id.to_s),
                        class: "form-check-input",
                        id: "category_#{category.id}",
                        data: {
                          "item-filter-target": "categoryCheckbox",
                          action: "change->item-filter#onCategoryChange"
                        } %>
                    <%= label_tag "category_#{category.id}", category.name, class: "form-check-label" %>
                  </div>
                <% end %>
              </div>
              <div class="mt-2">
                <div class="form-check form-check-inline">
                  <%= radio_button_tag :category_match, "any", params[:category_match] != "all",
                      class: "form-check-input",
                      data: {
                        "item-filter-target": "categoryMatchRadio",
                        action: "change->item-filter#onCategoryMatchChange"
                      } %>
                  <%= label_tag :category_match_any, "Any selected", class: "form-check-label" %>
                </div>
                <div class="form-check form-check-inline">
                  <%= radio_button_tag :category_match, "all", params[:category_match] == "all",
                      class: "form-check-input",
                      data: {
                        "item-filter-target": "categoryMatchRadio",
                        action: "change->item-filter#onCategoryMatchChange"
                      } %>
                  <%= label_tag :category_match_all, "All selected", class: "form-check-label" %>
                </div>
              </div>
              <small class="form-text text-muted">Select multiple categories to filter</small>
            </div>
          </div>

          <div class="mb-3">
            <button class="btn btn-link p-0 text-decoration-none text-start w-100 d-flex justify-content-between align-items-center"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#itemTypeCollapse"
                    aria-expanded="false"
                    aria-controls="itemTypeCollapse">
              <span class="form-label mb-0">Item Type</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
              </svg>
            </button>
            <div class="collapse" id="itemTypeCollapse">
              <%= select_tag :item_type,
                  options_for_select([['All Types', '']] + Item::ITEM_TYPES.map { |t| [t, t] }, params[:item_type]),
                  class: "form-select mt-2",
                  data: {
                    "item-filter-target": "itemTypeSelect",
                    action: "change->item-filter#onItemTypeChange"
                  } %>
            </div>
          </div>

          <div class="mb-3">
            <button class="btn btn-link p-0 text-decoration-none text-start w-100 d-flex justify-content-between align-items-center"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#stockStatusCollapse"
                    aria-expanded="false"
                    aria-controls="stockStatusCollapse">
              <span class="form-label mb-0">Stock Status</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
              </svg>
            </button>
            <div class="collapse" id="stockStatusCollapse">
              <%= select_tag :stock_status,
                  options_for_select([
                    ['All Items', ''],
                    ['In Stock', 'in_stock'],
                    ['Low Stock', 'low_stock'],
                    ['Out of Stock', 'out_of_stock']
                  ], params[:stock_status]),
                  class: "form-select mt-2",
                  data: {
                    "item-filter-target": "stockStatusSelect",
                    action: "change->item-filter#onStockStatusChange"
                  } %>
            </div>
          </div>

          <button type="button" class="btn btn-outline-secondary w-100" data-action="click->item-filter#clearFilters">
            Clear All Filters
          </button>

          <div class="mt-3 text-center">
            <small class="text-muted" data-item-filter-target="resultsCount"></small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-9 col-md-8">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Inventory</h1>
        <div class="d-flex gap-2 flex-wrap">
          <button type="button"
                  class="btn btn-outline-danger responsive-btn"
                  data-action="click->item-filter#showOutOfStock"
                  data-item-filter-target="needsRestockingBtn">
            <span class="btn-text-mobile">Out of Stock</span>
            <span class="btn-text-desktop">Show Out of Stock</span>
          </button>
          <% unless current_user&.guest? %>
            <%= link_to new_item_path, class: "btn btn-success responsive-btn", data: { offline_target: "addButton" } do %>
              <span class="btn-text-mobile">Add Item</span>
              <span class="btn-text-desktop">Add New Item</span>
            <% end %>
          <% end %>
        </div>
      </div>

      <% if @items.any? %>
        <div class="items-list <%= 'guest-view' if current_user&.guest? %>">
          <div class="items-header d-none d-md-flex">
            <div class="header-image">Image</div>
            <div class="header-name">Name</div>
            <% if current_user&.guest? %>
              <div class="header-owner">Owner</div>
            <% end %>
            <div class="header-categories">Categories</div>
            <div class="header-type">Type</div>
            <div class="header-quantity">Quantity</div>
            <div class="header-actions">Actions</div>
          </div>

          <% @items.each do |item| %>
            <%= render "item_row", item: item, show_owner: current_user&.guest?, show_actions: !current_user&.guest? %>
          <% end %>
        </div>

        <div class="alert alert-info d-none" data-item-filter-target="noResults">
          No items match your filters. Try adjusting your search criteria.
        </div>
      <% else %>
        <div class="alert alert-info">
          No items found. <%= link_to "Add your first item", new_item_path, class: "alert-link" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
